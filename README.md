/*
	@author: alfonsohdez
	@date: 03/12/2018
*/


-- PART I: PointSales Database Creation Script
--  This part of the script was generated by SqlDBM tool

-- ****************** SqlDBM: Microsoft SQL Server ******************
-- ******************************************************************

USE master;
GO

CREATE DATABASE GenericPointSales;
GO

USE GenericPointSales;
GO

CREATE SCHEMA [HR];
GO

CREATE SCHEMA [Sales];
GO


CREATE SCHEMA [Territory];
GO


CREATE SCHEMA [Production];
GO

--************************************** [Production].[Category]

CREATE TABLE [Production].[Category]
(
 [CategoryId]   INT NOT NULL ,
 [CategoryName] NVARCHAR(50) NOT NULL ,

 CONSTRAINT [PK_Category] PRIMARY KEY CLUSTERED ([CategoryId] ASC)
);
GO



--************************************** [Territory].[Country]

CREATE TABLE [Territory].[Country]
(
 [CountryCode] NVARCHAR(5) NOT NULL ,
 [CountryName] NVARCHAR(60) NOT NULL ,

 CONSTRAINT [PK_Country] PRIMARY KEY CLUSTERED ([CountryCode] ASC)
);
GO



--************************************** [Sales].[SalesTerritory]

CREATE TABLE [Sales].[SalesTerritory]
(
 [TerritoryId] INT NOT NULL ,
 [Name]        NVARCHAR(50) NOT NULL ,
 [CountryCode] NVARCHAR(5) NOT NULL ,

 CONSTRAINT [PK_SalesTerritory] PRIMARY KEY CLUSTERED ([TerritoryId] ASC),
 CONSTRAINT [FK_128] FOREIGN KEY ([CountryCode])
  REFERENCES [Territory].[Country]([CountryCode])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_128] ON [Sales].[SalesTerritory] 
 (
  [CountryCode] ASC
 )

GO


--************************************** [Production].[Product]

CREATE TABLE [Production].[Product]
(
 [ProductId]      INT NOT NULL ,
 [ProductName]    NVARCHAR(50) NOT NULL ,
 [CategoryId]     INT NOT NULL ,
 [UnitPrice]      FLOAT NOT NULL ,
 [IsDiscontinued] BIT NOT NULL ,

 CONSTRAINT [PK_Product] PRIMARY KEY CLUSTERED ([ProductId] ASC),
 CONSTRAINT [FK_61] FOREIGN KEY ([CategoryId])
  REFERENCES [Production].[Category]([CategoryId])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_61] ON [Production].[Product] 
 (
  [CategoryId] ASC
 )

GO


--************************************** [Territory].[City]

CREATE TABLE [Territory].[City]
(
 [CityId]      INT NOT NULL ,
 [CityName]    NVARCHAR(60) NOT NULL ,
 [CountryCode] NVARCHAR(5) NOT NULL ,

 CONSTRAINT [PK_City] PRIMARY KEY CLUSTERED ([CityId] ASC),
 CONSTRAINT [FK_38] FOREIGN KEY ([CountryCode])
  REFERENCES [Territory].[Country]([CountryCode])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_38] ON [Territory].[City] 
 (
  [CountryCode] ASC
 )

GO


--************************************** [Sales].[Customers]

CREATE TABLE [Sales].[Customers]
(
 [CustomerId] INT NOT NULL ,
 [FirstName]  NVARCHAR(50) NOT NULL ,
 [LastName]   NVARCHAR(50) NOT NULL ,
 [CityId]     INT NULL ,

 CONSTRAINT [PK_Customers] PRIMARY KEY CLUSTERED ([CustomerId] ASC),
 CONSTRAINT [FK_46] FOREIGN KEY ([CityId])
  REFERENCES [Territory].[City]([CityId])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_46] ON [Sales].[Customers] 
 (
  [CityId] ASC
 )

GO


--************************************** [HR].[Employees]

CREATE TABLE [HR].[Employees]
(
 [EmployeeId] INT NOT NULL ,
 [FirstName]  NVARCHAR(50) NOT NULL ,
 [LastName]   NVARCHAR(50) NOT NULL ,
 [BirthDate]  DATE NULL ,
 [HireDate]   DATE NOT NULL ,
 [CityId]     INT NULL ,

 CONSTRAINT [PK_Employees] PRIMARY KEY CLUSTERED ([EmployeeId] ASC),
 CONSTRAINT [FK_42] FOREIGN KEY ([CityId])
  REFERENCES [Territory].[City]([CityId])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_42] ON [HR].[Employees] 
 (
  [CityId] ASC
 )

GO


--************************************** [Sales].[Order]

CREATE TABLE [Sales].[Order]
(
 [OrderId]      INT NOT NULL ,
 [CustomerId]   INT NOT NULL ,
 [EmployeeId]   INT NOT NULL ,
 [OrderDate]    DATE NOT NULL ,
 [RequiredDate] DATE NOT NULL ,
 [ShippedDate]  DATE NULL ,
 [TerritoryId]  INT NOT NULL ,

 CONSTRAINT [PK_Order] PRIMARY KEY CLUSTERED ([OrderId] ASC),
 CONSTRAINT [FK_78] FOREIGN KEY ([CustomerId])
  REFERENCES [Sales].[Customers]([CustomerId]),
 CONSTRAINT [FK_82] FOREIGN KEY ([EmployeeId])
  REFERENCES [HR].[Employees]([EmployeeId]),
 CONSTRAINT [FK_132] FOREIGN KEY ([TerritoryId])
  REFERENCES [Sales].[SalesTerritory]([TerritoryId])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_78] ON [Sales].[Order] 
 (
  [CustomerId] ASC
 )

GO

CREATE NONCLUSTERED INDEX [fkIdx_82] ON [Sales].[Order] 
 (
  [EmployeeId] ASC
 )

GO

CREATE NONCLUSTERED INDEX [fkIdx_132] ON [Sales].[Order] 
 (
  [TerritoryId] ASC
 )

GO


--************************************** [Sales].[OrderDetail]

CREATE TABLE [Sales].[OrderDetail]
(
 [OrderId]   INT NOT NULL ,
 [ProductId] INT NOT NULL ,
 [Quantity]  INT NOT NULL ,
 [UnitPrice] MONEY NOT NULL ,

 CONSTRAINT [PK_OrderDetail] PRIMARY KEY CLUSTERED ([OrderId] ASC, [ProductId] ASC),
 CONSTRAINT [FK_111] FOREIGN KEY ([OrderId])
  REFERENCES [Sales].[Order]([OrderId]),
 CONSTRAINT [FK_115] FOREIGN KEY ([ProductId])
  REFERENCES [Production].[Product]([ProductId])
);
GO


CREATE NONCLUSTERED INDEX [fkIdx_111] ON [Sales].[OrderDetail] 
 (
  [OrderId] ASC
 )

GO

CREATE NONCLUSTERED INDEX [fkIdx_115] ON [Sales].[OrderDetail] 
 (
  [ProductId] ASC
 )

GO

-- PART II: PointSales Database Fill Script 
--  The data of this database it's taken from AdventureWorks database
-- NOTE: Ensure you have installed AdventureWorks database

USE GenericPointSales;
GO

-- Territory.Country --
INSERT INTO Territory.Country
SELECT 
	CountryRegionCode,
	[Name]
FROM AdventureWorks.Person.CountryRegion;
GO

-- Territory.City --
INSERT INTO Territory.City
SELECT
	StateProvinceID,
	[Name],
	CountryRegionCode
FROM AdventureWorks.Person.StateProvince;
GO

-- Sales.SalesTerritory --
INSERT INTO Sales.SalesTerritory
SELECT
	TerritoryID,
	[Name],
	CountryRegionCode
FROM AdventureWorks.Sales.SalesTerritory;
GO

-- HR.Employees --
INSERT INTO HR.Employees
SELECT 
	p.BusinessEntityID,
	p.FirstName,
	p.LastName,
	e.BirthDate,
	e.HireDate,
	(SELECT TOP(1) a.StateProvinceID 
		FROM AdventureWorks.Person.BusinessEntityAddress AS bea
			INNER JOIN AdventureWorks.Person.Address AS a 
				ON bea.AddressID = a.AddressID
		WHERE bea.BusinessEntityID = p.BusinessEntityID) AS StateProvinceId
FROM AdventureWorks.Person.Person AS p
	INNER JOIN AdventureWorks.HumanResources.Employee AS e
		ON p.BusinessEntityID = e.BusinessEntityID;
GO

-- Production.Category --
INSERT INTO Production.Category
SELECT
	ProductCategoryID,
	[Name]
FROM AdventureWorks.Production.ProductCategory;
GO

-- Production.Product --
INSERT INTO Production.Product
SELECT
	p.ProductID,
	p.[Name],
	ps.ProductCategoryID,
	p.StandardCost,
	CASE
		WHEN p.DiscontinuedDate IS NOT NULL THEN 1
		ELSE 0
	END AS IsDiscontinued
FROM AdventureWorks.Production.Product AS p
	INNER JOIN AdventureWorks.Production.ProductSubcategory AS ps
		ON p.ProductSubcategoryID = ps.ProductSubcategoryID
GO

-- Sales.Customers --
INSERT INTO Sales.Customers
SELECT
	c.CustomerID,
	p.FirstName,
	p.LastName,
	(SELECT TOP(1) a.StateProvinceID 
		FROM AdventureWorks.Person.BusinessEntityAddress AS bea
			INNER JOIN AdventureWorks.Person.Address AS a 
				ON bea.AddressID = a.AddressID
		WHERE bea.BusinessEntityID = p.BusinessEntityID) AS StateProvinceId
FROM AdventureWorks.Sales.Customer AS c
	INNER JOIN AdventureWorks.Person.Person AS p
		ON c.PersonID = p.BusinessEntityID
GO

-- Sales.Order --
INSERT INTO Sales.[Order]
SELECT 
	soh.SalesOrderID,
	soh.CustomerID,
	soh.SalesPersonID,
	soh.OrderDate,
	soh.DueDate,
	soh.ShipDate,
	soh.TerritoryID
FROM AdventureWorks.Sales.SalesOrderHeader AS soh
WHERE soh.TerritoryID IS NOT NULL
	AND soh.SalesPersonID IS NOT NULL
	AND EXISTS (SELECT * FROM Sales.Customers WHERE CustomerId = soh.CustomerID)
GO

-- Sales.OrderDetail --
INSERT INTO Sales.OrderDetail
SELECT
	sod.SalesOrderID,
	p.ProductID,
	sod.OrderQty,
	sod.UnitPrice
FROM AdventureWorks.Sales.SalesOrderDetail AS sod
	INNER JOIN Sales.[Order] AS so
		ON sod.SalesOrderID = so.OrderId
	INNER JOIN Production.Product AS p
		ON sod.ProductID = p.ProductId
GO
